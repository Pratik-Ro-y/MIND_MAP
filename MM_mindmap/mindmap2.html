<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MindMap Generator Platform</title>

        <!-- External Libraries -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/gojs/2.3.13/go.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-solid: #667eea;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-strong: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --shadow-lg: 0 15px 35px rgba(0,0,0,0.15);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--primary);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Glassmorphism Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-strong);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .logo i {
            margin-right: 0.75rem;
            font-size: 1.8rem;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Enhanced Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-solid);
            color: var(--primary-solid);
            backdrop-filter: blur(10px);
        }

        .btn-outline:hover {
            background: var(--primary-solid);
            color: white;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            min-height: calc(100vh - 80px);
            display: flex;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-right: 1px solid var(--glass-strong);
            height: calc(100vh - 80px);
            overflow-y: auto;
            transition: var(--transition);
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--glass);
            border-radius: 2px;
        }

        .sidebar-section {
            margin-bottom: 2.5rem;
        }

        .sidebar-section h3 {
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Enhanced MindMap List */
        .mindmap-list {
            list-style: none;
        }

        .mindmap-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .mindmap-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-solid), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .mindmap-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(8px) scale(1.02);
            border-left-color: var(--primary-solid);
            box-shadow: var(--shadow);
        }

        .mindmap-item:hover::before {
            opacity: 0.05;
        }

        .mindmap-item.active {
            background: var(--primary);
            color: white;
            border-left-color: var(--dark);
            transform: translateX(8px);
        }

        .mindmap-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .mindmap-meta {
            font-size: 0.8rem;
            opacity: 0.8;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .canvas-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--glass-strong);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--dark);
        }

        .canvas-tools {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            font-size: 1rem;
            position: relative;
        }

        .tool-btn:hover {
            background: var(--primary-solid);
            color: white;
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .tool-btn.active {
            background: var(--primary-solid);
            color: white;
        }

        /* MindMap Canvas */
        .mindmap-canvas {
            width: 100%;
            height: calc(100vh - 200px);
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                linear-gradient(45deg, rgba(255,255,255,0.02) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(255,255,255,0.02) 25%, transparent 25%);
            background-size: 60px 60px;
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
            margin: 1rem;
        }

        /* Enhanced Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border-radius: var(--border-radius);
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }

        .welcome-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: rotate 20s linear infinite;
        }

        .welcome-screen .content {
            position: relative;
            z-index: 1;
        }

        .welcome-screen i {
            font-size: 5rem;
            margin-bottom: 2rem;
            opacity: 0.8;
            animation: pulse 2s ease-in-out infinite;
        }

        .welcome-screen h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .welcome-screen p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            max-width: 600px;
            line-height: 1.6;
            opacity: 0.9;
        }

        /* Enhanced Properties Panel */
        .properties-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--glass-strong);
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }

        .properties-panel.active {
            display: block;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .properties-panel h3 {
            margin-bottom: 1.5rem;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.9);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-solid);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .color-picker {
            width: 100%;
            height: 45px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .color-picker:hover {
            border-color: var(--primary-solid);
        }

        /* Enhanced Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--glass-strong);
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            transform: rotate(90deg);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        /* File Upload Area */
        .upload-area {
            border: 2px dashed var(--glass-strong);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            margin: 2rem 0;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-solid);
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary-solid);
            margin-bottom: 1rem;
        }

        /* Animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
            
            .properties-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }
            
            .sidebar {
                position: fixed;
                left: -320px;
                transition: left 0.3s ease;
                z-index: 1001;
                height: 100vh;
                top: 0;
                width: 320px;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .properties-panel {
                position: fixed;
                top: 80px;
                left: 1rem;
                right: 1rem;
                width: auto;
            }

            .canvas-tools {
                gap: 0.25rem;
            }

            .tool-btn {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .logo {
                font-size: 1.2rem;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* User Menu */
        .user-menu {
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        /* Drag and Drop States */
        .node-dragging {
            opacity: 0.7;
            transform: rotate(5deg);
        }

        .drop-zone {
            border: 2px dashed var(--primary-solid);
            background: rgba(102, 126, 234, 0.1);
        }
    </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="#" class="logo">
                    <i class="fas fa-brain"></i>
                    MindMap Platform
                </a>

                <nav class="nav-buttons">
                    <button class="btn btn-outline" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        Login
                    </button>
                    <button class="btn btn-primary" id="signupBtn">
                        <i class="fas fa-user-plus"></i>
                        Sign Up
                    </button>
                    <div class="user-menu" id="userMenu">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <button class="btn btn-outline" id="profileBtn">
                            <i class="fas fa-user"></i>
                            Profile
                        </button>
                        <button class="btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-plus-circle"></i> Create New</h3>
                    <button class="btn btn-primary" style="width: 100%;"
                        id="newMindMapBtn">
                        <i class="fas fa-plus"></i>
                        New MindMap
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-upload"></i> Upload & Generate</h3>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>Upload Document</h4>
                        <p>Drop files here or click to browse</p>
                        <input type="file" id="fileInput"
                            accept=".txt,.pdf,.docx,.md" style="display: none;">
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-folder"></i> Categories</h3>
                    <select class="form-control" id="categoryFilter">
                        <option value>All Categories</option>
                    </select>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-search"></i> Search</h3>
                    <input type="text" class="form-control"
                        placeholder="Search mindmaps..." id="searchInput">
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-list"></i> My MindMaps</h3>
                    <ul class="mindmap-list" id="mindmapList">
                        <!-- Dynamic content -->
                    </ul>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-template"></i> Templates</h3>
                    <button class="btn btn-outline" style="width: 100%;"
                        id="templatesBtn">
                        <i class="fas fa-download"></i>
                        Browse Templates
                    </button>
                </div>
            </aside>

            <!-- Canvas Container -->
            <div class="canvas-container">
                <div class="canvas-header">
                    <div class="canvas-title" id="canvasTitle">Welcome to
                        MindMap Platform</div>
                    <div class="canvas-tools">
                        <button class="tool-btn" id="addNodeBtn"
                            title="Add Node">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="tool-btn" id="aiSuggestBtn"
                            title="AI Suggestions">
                            <i class="fas fa-robot"></i>
                        </button>
                        <button class="tool-btn" id="autoLayoutBtn"
                            title="Auto Layout">
                            <i class="fas fa-project-diagram"></i>
                        </button>
                        <button class="tool-btn" id="zoomInBtn" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="tool-btn" id="zoomOutBtn"
                            title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="tool-btn" id="fitToScreenBtn"
                            title="Fit to Screen">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <button class="tool-btn" id="saveBtn" title="Save">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="tool-btn" id="exportBtn" title="Export">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="tool-btn" id="shareBtn" title="Share">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>

                <div class="mindmap-canvas" id="mindmapCanvas">
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="content">
                            <i class="fas fa-brain"></i>
                            <h2>Welcome to MindMap Platform</h2>
                            <p>Create, organize, and visualize your ideas with
                                our powerful mind mapping tool. Upload documents
                                for AI-powered generation or start from
                                scratch.</p>
                            <button class="btn btn-primary" id="getStartedBtn">
                                <i class="fas fa-rocket"></i>
                                Get Started
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <h3><i class="fas fa-cog"></i> Node Properties</h3>

            <div class="form-group">
                <label for="nodeText">Text:</label>
                <textarea class="form-control" id="nodeText" rows="2"
                    placeholder="Enter node text..."></textarea>
            </div>

            <div class="form-group">
                <label for="nodeColor">Color:</label>
                <input type="color" class="color-picker" id="nodeColor"
                    value="#667eea">
            </div>

            <div class="form-group">
                <label for="nodeBackgroundColor">Background:</label>
                <input type="color" class="color-picker"
                    id="nodeBackgroundColor" value="#ffffff">
            </div>

            <div class="form-group">
                <label for="nodeFontSize">Font Size:</label>
                <select class="form-control" id="nodeFontSize">
                    <option value="10">10px</option>
                    <option value="12">12px</option>
                    <option value="14" selected>14px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                    <option value="24">24px</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nodeIcon">Icon:</label>
                <select class="form-control" id="nodeIcon">
                    <option value>No Icon</option>
                    <option value="fas fa-star">‚≠ê Star</option>
                    <option value="fas fa-heart">‚ù§Ô∏è Heart</option>
                    <option value="fas fa-lightbulb">üí° Idea</option>
                    <option value="fas fa-flag">üèÅ Flag</option>
                    <option value="fas fa-check-circle">‚úÖ Check</option>
                    <option value="fas fa-exclamation-triangle">‚ö†Ô∏è
                        Warning</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nodePriority">Priority:</label>
                <select class="form-control" id="nodePriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nodeStatus">Status:</label>
                <select class="form-control" id="nodeStatus">
                    <option value="pending" selected>Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nodeTags">Tags (comma-separated):</label>
                <input type="text" class="form-control" id="nodeTags"
                    placeholder="tag1, tag2, tag3">
            </div>

            <div class="form-group">
                <label for="nodeNotes">Notes:</label>
                <textarea class="form-control" id="nodeNotes" rows="3"
                    placeholder="Additional notes..."></textarea>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" id="applyPropertiesBtn"
                    style="flex: 1;">
                    <i class="fas fa-check"></i>
                    Apply
                </button>
                <button class="btn btn-outline" id="cancelPropertiesBtn"
                    style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Login Modal -->
        <div class="modal" id="loginModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Login to Your Account</h3>
                    <button class="modal-close"
                        onclick="closeModal('loginModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Username or Email:</label>
                        <input type="text" class="form-control"
                            id="loginUsername" required>
                    </div>

                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" class="form-control"
                            id="loginPassword" required>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary"
                            style="flex: 1;">
                            <i class="fas fa-sign-in-alt"></i>
                            Login
                        </button>
                        <button type="button" class="btn btn-outline"
                            onclick="showModal('signupModal'); closeModal('loginModal');">
                            Sign Up
                        </button>
                    </div>

                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="#"
                            style="color: var(--primary-solid); text-decoration: none;"
                            id="forgotPasswordLink">
                            Forgot Password?
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Signup Modal -->
        <div class="modal" id="signupModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create Your Account</h3>
                    <button class="modal-close"
                        onclick="closeModal('signupModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupUsername">Username:</label>
                        <input type="text" class="form-control"
                            id="signupUsername" required>
                    </div>

                    <div class="form-group">
                        <label for="signupEmail">Email:</label>
                        <input type="email" class="form-control"
                            id="signupEmail" required>
                    </div>

                    <div class="form-group">
                        <label for="signupPassword">Password:</label>
                        <input type="password" class="form-control"
                            id="signupPassword" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="signupConfirmPassword">Confirm
                            Password:</label>
                        <input type="password" class="form-control"
                            id="signupConfirmPassword" required minlength="6">
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary"
                            style="flex: 1;">
                            <i class="fas fa-user-plus"></i>
                            Sign Up
                        </button>
                        <button type="button" class="btn btn-outline"
                            onclick="showModal('loginModal'); closeModal('signupModal');">
                            Login
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New MindMap Modal -->
        <div class="modal" id="newMindMapModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New MindMap</h3>
                    <button class="modal-close"
                        onclick="closeModal('newMindMapModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="newMindMapForm">
                    <div class="form-group">
                        <label for="mindmapTitle">Title:</label>
                        <input type="text" class="form-control"
                            id="mindmapTitle" required
                            placeholder="Enter mindmap title">
                    </div>

                    <div class="form-group">
                        <label for="mindmapDescription">Description:</label>
                        <textarea class="form-control" id="mindmapDescription"
                            rows="3"
                            placeholder="Describe your mindmap..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="mindmapCategory">Category:</label>
                        <select class="form-control" id="mindmapCategory">
                            <option value>Select Category</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="centralNodeText">Central Node Text:</label>
                        <input type="text" class="form-control"
                            id="centralNodeText"
                            placeholder="Main topic or idea" required>
                    </div>

                    <div class="form-group">
                        <label for="mindmapTheme">Theme:</label>
                        <select class="form-control" id="mindmapTheme">
                            <option value="default">Default</option>
                            <option value="blue">Blue Ocean</option>
                            <option value="green">Nature</option>
                            <option value="purple">Purple Haze</option>
                            <option value="orange">Sunset</option>
                            <option value="dark">Dark Mode</option>
                        </select>
                    </div>

                    <div
                        style="display: flex; align-items: center; margin: 1.5rem 0;">
                        <input type="checkbox" id="mindmapPublic"
                            style="margin-right: 0.75rem; transform: scale(1.2);">
                        <label for="mindmapPublic">Make this mind map
                            public</label>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary"
                            style="flex: 1;">
                            <i class="fas fa-plus"></i>
                            Create MindMap
                        </button>
                        <button type="button" class="btn btn-outline"
                            onclick="closeModal('newMindMapModal')">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- AI Processing Modal -->
        <div class="modal" id="aiProcessingModal">
            <div class="modal-content" style="text-align: center;">
                <div class="modal-header">
                    <h3>AI Processing</h3>
                </div>

                <div style="padding: 2rem;">
                    <div class="loading"
                        style="width: 40px; height: 40px; border-width: 4px; margin: 0 auto 1rem;"></div>
                    <h4>Generating MindMap...</h4>
                    <p>Our AI is analyzing your content and creating a
                        structured mind map. This may take a few moments.</p>

                    <div style="margin-top: 2rem;">
                        <div id="aiProgress"
                            style="width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden;">
                            <div id="aiProgressBar"
                                style="width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease; border-radius: 3px;"></div>
                        </div>
                        <small id="aiProgressText"
                            style="display: block; margin-top: 0.5rem; color: var(--secondary);">Initializing...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Options Modal -->
        <div class="modal" id="exportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Export MindMap</h3>
                    <button class="modal-close"
                        onclick="closeModal('exportModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="form-group">
                    <label>Choose Export Format:</label>
                    <div
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-outline export-option"
                            data-format="png">
                            <i class="fas fa-image"></i>
                            PNG Image
                        </button>
                        <button class="btn btn-outline export-option"
                            data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            PDF Document
                        </button>
                        <button class="btn btn-outline export-option"
                            data-format="json">
                            <i class="fas fa-code"></i>
                            JSON Data
                        </button>
                        <button class="btn btn-outline export-option"
                            data-format="xml">
                            <i class="fas fa-file-code"></i>
                            XML Format
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
        /**
         * Enhanced MindMap Platform - Frontend JavaScript
         * Integrates with the provided PHP backend API
         */

        class MindMapPlatform {
            constructor() {
                this.apiBase = '/MM_mindmp/api/'; // Adjust based on your server setup
                this.authToken = this.getStorageItem('authToken');
                this.currentUser = null;
                this.currentMindMap = null;
                this.diagram = null;
                this.selectedNode = null;
                this.categories = [];
                this.mindmaps = [];
                this.isProcessingAI = false;
                
                this.init();
            }
            
            // Storage methods that work in artifact environment
            getStorageItem(key) {
                try {
                    return window.localStorage ? localStorage.getItem(key) : null;
                } catch (e) {
                    return null;
                }
            }
            
            setStorageItem(key, value) {
                try {
                    if (window.localStorage) {
                        localStorage.setItem(key, value);
                    }
                } catch (e) {
                    console.warn('Storage not available');
                }
            }
            
            removeStorageItem(key) {
                try {
                    if (window.localStorage) {
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    console.warn('Storage not available');
                }
            }
            
            async init() {
                try {
                    this.setupEventListeners();
                    this.initializeGoJS();
                    
                    if (this.authToken) {
                        await this.loadUserProfile();
                        await this.loadCategories();
                        await this.loadUserMindMaps();
                        this.showAuthenticatedUI();
                    } else {
                        this.showUnauthenticatedUI();
                    }
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.showToast('Failed to initialize application', 'error');
                }
            }
            
            setupEventListeners() {
                // Authentication
                document.getElementById('loginBtn').addEventListener('click', () => this.showModal('loginModal'));
                document.getElementById('signupBtn').addEventListener('click', () => this.showModal('signupModal'));
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('signupForm').addEventListener('submit', (e) => this.handleSignup(e));
                
                // MindMap operations
                document.getElementById('newMindMapBtn').addEventListener('click', () => this.showModal('newMindMapModal'));
                document.getElementById('getStartedBtn').addEventListener('click', () => this.showModal('newMindMapModal'));
                document.getElementById('newMindMapForm').addEventListener('submit', (e) => this.handleCreateMindMap(e));
                
                // File upload
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
                uploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                
                // Tools
                document.getElementById('addNodeBtn').addEventListener('click', () => this.addNode());
                document.getElementById('aiSuggestBtn').addEventListener('click', () => this.getAISuggestions());
                document.getElementById('autoLayoutBtn').addEventListener('click', () => this.autoLayout());
                document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
                document.getElementById('fitToScreenBtn').addEventListener('click', () => this.fitToScreen());
                document.getElementById('saveBtn').addEventListener('click', () => this.saveMindMap());
                document.getElementById('exportBtn').addEventListener('click', () => this.showModal('exportModal'));
                document.getElementById('shareBtn').addEventListener('click', () => this.shareMindMap());
                
                // Properties panel
                document.getElementById('applyPropertiesBtn').addEventListener('click', () => this.applyNodeProperties());
                document.getElementById('cancelPropertiesBtn').addEventListener('click', () => this.hidePropertiesPanel());
                
                // Search and filter
                document.getElementById('searchInput').addEventListener('input', (e) => this.filterMindMaps(e.target.value));
                document.getElementById('categoryFilter').addEventListener('change', (e) => this.filterByCategory(e.target.value));
                
                // Export options
                document.querySelectorAll('.export-option').forEach(btn => {
                btn.addEventListener('click', (e) => this.handleExport(e.currentTarget.dataset.format));
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
                
                // Window resize
                window.addEventListener('resize', () => this.resizeDiagram());
            }
            
            initializeGoJS() {
                if (typeof go === 'undefined') {
                    console.error('GoJS not loaded');
                    return;
                }
                
                const $ = go.GraphObject.make;
                
                this.diagram = $(go.Diagram, 'mindmapCanvas', {
                    initialContentAlignment: go.Spot.Center,
                    'undoManager.isEnabled': true,
                    'toolManager.hoverDelay': 100,
                    allowDrop: true,
                    allowClipboard: true,
                    'animationManager.isEnabled': true,
                    layout: $(go.TreeLayout, {
                        angle: 0,
                        arrangement: go.TreeLayout.ArrangementVertical,
                        treeStyle: go.TreeLayout.StyleLastParents,
                        alternateAngle: 90,
                        alternateAlignment: go.TreeLayout.AlignmentBus
                    })
                });
                
                // Enhanced node template with modern styling
                this.diagram.nodeTemplate = $(go.Node, 'Auto',
                    {
                        locationSpot: go.Spot.Center,
                        selectionChanged: (node) => this.onNodeSelectionChanged(node)
                    },
                    new go.Binding('location', 'loc', go.Point.parse).makeTwoWay(go.Point.stringify),
                    
                    // Node shape with gradient and shadow effect
                    $(go.Shape, 'RoundedRectangle', {
                        strokeWidth: 2,
                        stroke: '#667eea',
                        fill: '#ffffff',
                        portId: '',
                        cursor: 'pointer',
                        fromLinkable: true,
                        toLinkable: true,
                        fromSpot: go.Spot.AllSides,
                        toSpot: go.Spot.AllSides
                    },
                        new go.Binding('fill', 'backgroundColor'),
                        new go.Binding('stroke', 'color')
                    ),
                    
                    // Node content panel
                    $(go.Panel, 'Horizontal',
                        // Icon
                        $(go.TextBlock, {
                            margin: new go.Margin(0, 5, 0, 8),
                            font: '16px FontAwesome',
                            stroke: '#667eea'
                        },
                            new go.Binding('text', 'icon').makeTwoWay(),
                            new go.Binding('visible', 'icon', (icon) => icon !== null && icon !== ''),
                            new go.Binding('stroke', 'color')
                        ),
                        
                        // Text
                        $(go.TextBlock, {
                            margin: 8,
                            maxSize: new go.Size(200, NaN),
                            wrap: go.TextBlock.WrapFit,
                            textAlign: 'center',
                            editable: true,
                            cursor: 'pointer',
                            font: 'bold 14px Inter, sans-serif'
                        },
                            new go.Binding('text').makeTwoWay(),
                            new go.Binding('stroke', 'textColor'),
                            new go.Binding('font', 'fontSize', (size) => `bold ${size}px Inter, sans-serif`)
                        )
                    ),
                    
                    // Context menu
                    {
                        contextMenu: this.createContextMenu()
                    }
                );
                
                // Enhanced link template
                this.diagram.linkTemplate = $(go.Link, {
                        routing: go.Link.Orthogonal,
                        corner: 10,
                        selectable: false,
                        curve: go.Link.JumpGap
                    },
                    $(go.Shape, {
                        strokeWidth: 3,
                        stroke: '#667eea',
                        strokeDashArray: [2, 4]
                    },
                        new go.Binding('stroke', 'color')
                    )
                );
                
                // Event listeners
                this.diagram.addDiagramListener('SelectionChanged', () => this.onSelectionChanged());
                this.diagram.addDiagramListener('Modified', () => this.onDiagramModified());
                this.diagram.addDiagramListener('ObjectDoubleClicked', (e) => {
                    const part = e.subject.part;
                    if (part instanceof go.Node) {
                        this.editNode(part);
                    }
                });
                
                this.hideWelcomeScreen();
            }
            
            createContextMenu() {
                if (typeof go === 'undefined') return null;
                
                const $ = go.GraphObject.make;
                
                return $('ContextMenu',
                    $('ContextMenuButton',
                        $(go.TextBlock, 'Add Child Node'),
                        { click: (e, obj) => this.addChildNode(obj.part.adornedPart) }
                    ),
                    $('ContextMenuButton',
                        $(go.TextBlock, 'Edit Properties'),
                        { click: (e, obj) => this.editNode(obj.part.adornedPart) }
                    ),
                    $('ContextMenuButton',
                        $(go.TextBlock, 'Change Color'),
                        { click: (e, obj) => this.changeNodeColor(obj.part.adornedPart) }
                    ),
                    $('ContextMenuButton',
                        $(go.TextBlock, 'Delete Node'),
                        { click: (e, obj) => this.deleteNode(obj.part.adornedPart) }
                    )
                );
            }
            
            // File Upload and AI Processing
            handleFileDrop(e) {
                e.preventDefault();
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.processUploadedFile(files[0]);
                }
            }
            
            handleFileUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    this.processUploadedFile(file);
                }
            }
            
            async processUploadedFile(file) {
                if (!this.authToken) {
                    this.showToast('Please login to upload files', 'warning');
                    return;
                }
                
                const allowedTypes = ['text/plain', 'application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/markdown'];
                
                if (!allowedTypes.includes(file.type)) {
                    this.showToast('Unsupported file type. Please upload TXT, PDF, DOCX, or MD files.', 'error');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    this.showToast('File too large. Maximum size is 10MB.', 'error');
                    return;
                }
                
                try {
                    this.showModal('aiProcessingModal');
                    this.updateAIProgress(10, 'Reading file...');
                    
                    const content = await this.readFileContent(file);
                    this.updateAIProgress(30, 'Processing content...');
                    
                    // Simulate AI processing (replace with actual API call)
                    await this.generateMindMapFromContent(content, file.name);
                    
                } catch (error) {
                    console.error('File processing failed:', error);
                    this.showToast('Failed to process file', 'error');
                    this.closeModal('aiProcessingModal');
                }
            }
            
            readFileContent(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
            
            async generateMindMapFromContent(content, filename) {
                try {
                    this.updateAIProgress(50, 'Analyzing content...');
                    
                    // Extract key topics and create mind map structure
                    const mindmapData = this.analyzeContentForMindMap(content);
                    
                    this.updateAIProgress(80, 'Creating mind map...');
                    
                    // Create new mindmap
                    const response = await this.apiCall('mindmap_api.php?action=create', 'POST', {
                        title: `AI Generated: ${filename}`,
                        description: `Generated from uploaded file: ${filename}`,
                        central_node: mindmapData.central_topic,
                        theme: 'blue',
                        is_public: false
                    });
                    
                    if (response.success) {
                        const map_id = response.data.map_id;
                        
                        // Create nodes from analyzed content
                        await this.createNodesFromAnalysis(map_id, mindmapData);
                        
                        this.updateAIProgress(100, 'Complete!');
                        
                        setTimeout(() => {
                            this.closeModal('aiProcessingModal');
                            this.loadMindMap(map_id);
                            this.showToast('AI MindMap generated successfully!', 'success');
                        }, 1000);
                    }
                    
                } catch (error) {
                    this.closeModal('aiProcessingModal');
                    throw error;
                }
            }
            
            analyzeContentForMindMap(content) {
                // Simple content analysis (enhance with actual AI/NLP)
                const lines = content.split('\n').filter(line => line.trim());
                const words = content.toLowerCase().split(/\s+/);
                
                // Find most common words as potential topics
                const wordFreq = {};
                words.forEach(word => {
                    word = word.replace(/[^\w]/g, '');
                    if (word.length > 3) {
                        wordFreq[word] = (wordFreq[word] || 0) + 1;
                    }
                });
                
                const sortedWords = Object.entries(wordFreq)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                // Create basic structure
                return {
                    central_topic: sortedWords[0] ? sortedWords[0][0] : 'Main Topic',
                    main_branches: sortedWords.slice(1, 6).map(([word]) => ({
                        text: word.charAt(0).toUpperCase() + word.slice(1),
                        children: []
                    })),
                    content_summary: lines.slice(0, 5)
                };
            }
            
            async createNodesFromAnalysis(map_id, mindmapData) {
                // Create main branches
                for (let i = 0; i < mindmapData.main_branches.length; i++) {
                    const branch = mindmapData.main_branches[i];
                    await this.apiCall(`mindmap_api.php?action=create-node&map_id=${map_id}`, 'POST', {
                        node_text: branch.text,
                        node_type: 'main',
                        position_x: 1000 + (i * 200) - 400,
                        position_y: 750 + (i % 2 ? 100 : -100),
                        color: `hsl(${i * 60}, 70%, 60%)`,
                        background_color: '#ffffff'
                    });
                }
            }
            
            updateAIProgress(percent, text) {
                document.getElementById('aiProgressBar').style.width = `${percent}%`;
                document.getElementById('aiProgressText').textContent = text;
            }
            
            // Enhanced Authentication Methods
            async handleLogin(e) {
                e.preventDefault();
                
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!username || !password) {
                    this.showToast('Please fill in all fields', 'warning');
                    return;
                }
                
                try {
                    const response = await this.apiCall('auth.php?action=login', 'POST', {
                        username: username.trim(),
                        password
                    });
                    
                    if (response.success) {
                        this.authToken = response.data.token;
                        this.currentUser = response.data.user;
                        this.setStorageItem('authToken', this.authToken);
                        
                        this.closeModal('loginModal');
                        this.showAuthenticatedUI();
                        this.showToast(`Welcome back, ${this.currentUser.username}!`, 'success');
                        
                        await this.loadCategories();
                        await this.loadUserMindMaps();
                        
                        // Clear form
                        document.getElementById('loginForm').reset();
                    } else {
                        this.showToast(response.message || 'Login failed', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.showToast('Login failed. Please try again.', 'error');
                }
            }
            
            async handleSignup(e) {
                e.preventDefault();
                
                const username = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                
                if (!username || !email || !password || !confirmPassword) {
                    this.showToast('Please fill in all fields', 'warning');
                    return;
                }
                
                if (password !== confirmPassword) {
                    this.showToast('Passwords do not match', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    this.showToast('Password must be at least 6 characters', 'error');
                    return;
                }
                
                try {
                    const response = await this.apiCall('auth.php?action=register', 'POST', {
                        username,
                        email,
                        password
                    });
                    
                    if (response.success) {
                        this.closeModal('signupModal');
                        this.showToast('Account created successfully! Please login.', 'success');
                        this.showModal('loginModal');
                        
                        // Pre-fill login form
                        document.getElementById('loginUsername').value = username;
                        
                        // Clear signup form
                        document.getElementById('signupForm').reset();
                    } else {
                        this.showToast(response.message || 'Registration failed', 'error');
                    }
                } catch (error) {
                    console.error('Signup error:', error);
                    this.showToast('Registration failed. Please try again.', 'error');
                }
            }
            
            logout() {
                this.authToken = null;
                this.currentUser = null;
                this.currentMindMap = null;
                this.removeStorageItem('authToken');
                
                this.showUnauthenticatedUI();
                this.clearCanvas();
                this.showToast('Logged out successfully', 'info');
            }
            
            async apiCall(endpoint, method = 'GET', data = null) {
                const url = this.apiBase + endpoint;
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (this.authToken) {
                    options.headers['Authorization'] = `Bearer ${this.authToken}`;
                }
                
                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }
                
                try {
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            }
            
            // MindMap CRUD Operations
            async handleCreateMindMap(e) {
                e.preventDefault();
                
                const title = document.getElementById('mindmapTitle').value.trim();
                const description = document.getElementById('mindmapDescription').value.trim();
                const category_id = document.getElementById('mindmapCategory').value || null;
                const central_node = document.getElementById('centralNodeText').value.trim();
                const theme = document.getElementById('mindmapTheme').value;
                const is_public = document.getElementById('mindmapPublic').checked;
                
                if (!title || !central_node) {
                    this.showToast('Title and central node text are required', 'warning');
                    return;
                }
                
                try {
                    const response = await this.apiCall('mindmap_api.php?action=create', 'POST', {
                        title,
                        description,
                        category_id,
                        central_node,
                        theme,
                        is_public
                    });
                    
                    if (response.success) {
                        this.closeModal('newMindMapModal');
                        this.showToast('MindMap created successfully!', 'success');
                        
                        await this.loadUserMindMaps();
                        await this.loadMindMap(response.data.map_id);
                        
                        // Clear form
                        document.getElementById('newMindMapForm').reset();
                    } else {
                        this.showToast(response.message || 'Failed to create mindmap', 'error');
                    }
                } catch (error) {
                    console.error('Create mindmap error:', error);
                    this.showToast('Failed to create mindmap. Please try again.', 'error');
                }
            }
            
            async loadMindMap(mapId) {
                if (!this.authToken) {
                    this.showToast('Please login to view mindmaps', 'warning');
                    return;
                }
                
                try {
                    const response = await this.apiCall(`mindmap_api.php?action=get&map_id=${mapId}`, 'GET');
                    
                    if (response.success) {
                        this.currentMindMap = response.data;
                        this.displayMindMap(response.data);
                        this.updateCanvasTitle(response.data.title);
                        this.hideWelcomeScreen();
                        this.showToast('MindMap loaded successfully', 'success');
                    } else {
                        this.showToast(response.message || 'Failed to load mindmap', 'error');
                    }
                } catch (error) {
                    console.error('Load mindmap error:', error);
                    this.showToast('Failed to load mindmap', 'error');
                }
            }
            
            async loadUserMindMaps() {
                if (!this.authToken) return;
                
                try {
                    const response = await this.apiCall('mindmap_api.php?action=list', 'GET');
                    
                    if (response.success) {
                        this.mindmaps = response.data;
                        this.displayMindMapList(response.data);
                    }
                } catch (error) {
                    console.error('Failed to load mindmaps:', error);
                }
            }
            
            async saveMindMap() {
                if (!this.currentMindMap || !this.diagram) {
                    this.showToast('No mindmap to save', 'warning');
                    return;
                }
                
                try {
                    this.showToast('Saving...', 'info');
                    
                    // Get current diagram state
                    const diagramData = this.diagram.model.toJson();
                    const parsedData = JSON.parse(diagramData);
                    
                    // Save nodes
                    for (const nodeData of parsedData.nodeDataArray || []) {
                        if (nodeData.isNew) {
                            await this.createNode(nodeData);
                            delete nodeData.isNew;
                        } else if (nodeData.isModified) {
                            await this.updateNode(nodeData);
                            delete nodeData.isModified;
                        }
                    }
                    
                    // Update mindmap metadata
                    const updateData = {
                        canvas_width: this.diagram.documentBounds.width,
                        canvas_height: this.diagram.documentBounds.height,
                        zoom_level: this.diagram.scale,
                        center_x: this.diagram.position.x,
                        center_y: this.diagram.position.y
                    };
                    
                    await this.apiCall(`mindmap_api.php?action=update&map_id=${this.currentMindMap.map_id}`, 'PUT', updateData);
                    
                    this.showToast('MindMap saved successfully!', 'success');
                } catch (error) {
                    console.error('Save error:', error);
                    this.showToast('Failed to save mindmap', 'error');
                }
            }
            
            async createNode(nodeData) {
                try {
                    const response = await this.apiCall(`mindmap_api.php?action=create-node&map_id=${this.currentMindMap.map_id}`, 'POST', {
                        node_text: nodeData.text,
                        node_type: nodeData.nodeType || 'main',
                        color: nodeData.color || '#667eea',
                        background_color: nodeData.backgroundColor || '#ffffff',
                        text_color: nodeData.textColor || '#000000',
                        position_x: nodeData.loc ? parseFloat(nodeData.loc.split(' ')[0]) : 0,
                        position_y: nodeData.loc ? parseFloat(nodeData.loc.split(' ')[1]) : 0,
                        width: nodeData.width || 150,
                        height: nodeData.height || 50,
                        font_size: nodeData.fontSize || 14,
                        icon: nodeData.icon || null,
                        priority: nodeData.priority || 'medium',
                        status: nodeData.status || 'pending',
                        notes: nodeData.notes || null
                    });
                    
                    if (response.success) {
                        nodeData.key = response.data.node_id;
                        return response.data.node_id;
                    }
                } catch (error) {
                    console.error('Failed to create node:', error);
                    throw error;
                }
            }
            
            async updateNode(nodeData) {
                try {
                    await this.apiCall(`mindmap_api.php?action=update-node&node_id=${nodeData.key}`, 'PUT', {
                        node_text: nodeData.text,
                        color: nodeData.color,
                        background_color: nodeData.backgroundColor,
                        text_color: nodeData.textColor,
                        position_x: nodeData.loc ? parseFloat(nodeData.loc.split(' ')[0]) : 0,
                        position_y: nodeData.loc ? parseFloat(nodeData.loc.split(' ')[1]) : 0,
                        font_size: nodeData.fontSize,
                        icon: nodeData.icon,
                        priority: nodeData.priority,
                        status: nodeData.status,
                        notes: nodeData.notes
                    });
                } catch (error) {
                    console.error('Failed to update node:', error);
                    throw error;
                }
            }
            
            // Canvas Operations
            displayMindMap(mindmapData) {
                if (!this.diagram) return;
                
                const nodeDataArray = [];
                const linkDataArray = [];
                
                // Convert nodes to GoJS format
                (mindmapData.nodes || []).forEach(node => {
                    nodeDataArray.push({
                        key: node.node_id,
                        text: node.node_text,
                        color: node.color,
                        backgroundColor: node.background_color,
                        textColor: node.text_color,
                        fontSize: node.font_size,
                        icon: node.icon,
                        nodeType: node.node_type,
                        priority: node.priority,
                        status: node.status,
                        notes: node.notes,
                        loc: `${node.position_x} ${node.position_y}`
                    });
                    
                    // Create links for parent-child relationships
                    if (node.parent_id) {
                        linkDataArray.push({
                            from: node.parent_id,
                            to: node.node_id
                        });
                    }
                });
                
                // Update diagram model
                this.diagram.model = new go.TreeModel(nodeDataArray);
                if (linkDataArray.length > 0) {
                    this.diagram.model.linkDataArray = linkDataArray;
                }
                
                // Set canvas properties
                if (mindmapData.zoom_level) {
                    this.diagram.scale = mindmapData.zoom_level;
                }
                if (mindmapData.center_x && mindmapData.center_y) {
                    this.diagram.position = new go.Point(mindmapData.center_x, mindmapData.center_y);
                }
                
                setTimeout(() => this.fitToScreen(), 500);
            }
            
            addNode() {
                if (!this.currentMindMap || !this.diagram) {
                    this.showToast('Please select or create a mindmap first', 'warning');
                    return;
                }
                
                const centerPoint = this.diagram.viewportBounds.center;
                const newNodeData = {
                    key: 'temp_' + Date.now(),
                    text: 'New Node',
                    color: '#667eea',
                    backgroundColor: '#ffffff',
                    textColor: '#000000',
                    fontSize: 14,
                    nodeType: 'main',
                    priority: 'medium',
                    status: 'pending',
                    loc: `${centerPoint.x} ${centerPoint.y}`,
                    isNew: true
                };
                
                this.diagram.model.addNodeData(newNodeData);
                const node = this.diagram.findNodeForKey(newNodeData.key);
                if (node) {
                    this.diagram.select(node);
                }
            }
            
            addChildNode(parentNodetext = 'Child Node') {
                if (!parentNode || !this.currentMindMap || !this.diagram) return;
                
                const parentData = parentNode.data;
                const parentPoint = parentNode.location;
                
                const newNodeData = {
                    key: 'temp_' + Date.now(),
                    text: text,
                    color: parentData.color,
                    backgroundColor: '#ffffff',
                    textColor: '#000000',
                    fontSize: Math.max(parentData.fontSize - 2, 10),
                    nodeType: 'sub',
                    priority: 'medium',
                    status: 'pending',
                    loc: `${parentPoint.x + 200} ${parentPoint.y + 50}`,
                    isNew: true
                };
                
                this.diagram.model.addNodeData(newNodeData);
                this.diagram.model.addLinkData({
                    from: parentData.key,
                    to: newNodeData.key
                });
                
                const node = this.diagram.findNodeForKey(newNodeData.key);
                if (node) {
                    this.diagram.select(node);
                }
            }
            
            deleteNode(node) {
                if (!node || !this.diagram) return;
                
                if (confirm('Are you sure you want to delete this node and all its children?')) {
                    this.diagram.model.removeNodeData(node.data);
                }
            }
            
            editNode(node) {
                if (!node) return;
                
                this.selectedNode = node;
                this.populatePropertiesPanel(node.data);
                this.showPropertiesPanel();
            }
            
            changeNodeColor(node) {
                if (!node) return;
                
                const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#feca57', '#ff6b6b'];
                const currentColor = node.data.color;
                const currentIndex = colors.indexOf(currentColor);
                const nextColor = colors[(currentIndex + 1) % colors.length];
                
                this.diagram.model.setDataProperty(node.data, 'color', nextColor);
                this.diagram.model.setDataProperty(node.data, 'isModified', true);
            }
            
            // Properties Panel Methods
            populatePropertiesPanel(nodeData) {
                document.getElementById('nodeText').value = nodeData.text || '';
                document.getElementById('nodeColor').value = nodeData.color || '#667eea';
                document.getElementById('nodeBackgroundColor').value = nodeData.backgroundColor || '#ffffff';
                document.getElementById('nodeFontSize').value = nodeData.fontSize || 14;
                document.getElementById('nodeIcon').value = nodeData.icon || '';
                document.getElementById('nodePriority').value = nodeData.priority || 'medium';
                document.getElementById('nodeStatus').value = nodeData.status || 'pending';
                document.getElementById('nodeTags').value = Array.isArray(nodeData.tags) ? nodeData.tags.join(', ') : '';
                document.getElementById('nodeNotes').value = nodeData.notes || '';
            }
            
            applyNodeProperties() {
                if (!this.selectedNode || !this.diagram) return;
                
                const updatedData = {
                    text: document.getElementById('nodeText').value,
                    color: document.getElementById('nodeColor').value,
                    backgroundColor: document.getElementById('nodeBackgroundColor').value,
                    fontSize: parseInt(document.getElementById('nodeFontSize').value),
                    icon: document.getElementById('nodeIcon').value,
                    priority: document.getElementById('nodePriority').value,
                    status: document.getElementById('nodeStatus').value,
                    notes: document.getElementById('nodeNotes').value,
                    isModified: true
                };
                
                // Apply changes to diagram
                Object.keys(updatedData).forEach(key => {
                    this.diagram.model.setDataProperty(this.selectedNode.data, key, updatedData[key]);
                });
                
                this.hidePropertiesPanel();
                this.showToast('Node properties updated', 'success');
            }
            
            showPropertiesPanel() {
                document.getElementById('propertiesPanel').classList.add('active');
            }
            
            hidePropertiesPanel() {
                document.getElementById('propertiesPanel').classList.remove('active');
                this.selectedNode = null;
            }
            
            // Canvas Control Methods
            autoLayout() {
                if (!this.diagram) return;
                this.diagram.layoutDiagram(true);
                this.showToast('Auto layout applied', 'info');
            }
            
            zoomIn() {
                if (!this.diagram) return;
                this.diagram.commandHandler.increaseZoom();
            }
            
            zoomOut() {
                if (!this.diagram) return;
                this.diagram.commandHandler.decreaseZoom();
            }
            
            fitToScreen() {
                if (!this.diagram) return;
                this.diagram.zoomToFit();
            }
            
            resizeDiagram() {
                if (this.diagram) {
                    this.diagram.requestUpdate();
                }
            }
            
            // Export Methods
            async handleExport(format) {
                if (!this.currentMindMap) {
                    this.showToast('No mindmap to export', 'warning');
                    return;
                }
                
                this.closeModal('exportModal');
                
                try {
                    if (format === 'png' || format === 'pdf') {
                        await this.exportAsImage(format);
                    } else {
                        const response = await this.apiCall(`mindmap_api.php?action=export&map_id=${this.currentMindMap.map_id}&format=${format}`, 'GET');
                        if (response.success || response.data) {
                            this.downloadFile(response.data || response, `mindmap_${this.currentMindMap.map_id}.${format}`);
                        }
                    }
                    
                    this.showToast('Export completed successfully', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showToast('Export failed', 'error');
                }
            }
            
            async exportAsImage(format) {
                if (typeof html2canvas === 'undefined') {
                    this.showToast('Image export not available', 'error');
                    return;
                }
                
                try {
                    const canvas = await html2canvas(document.getElementById('mindmapCanvas'), {
                        backgroundColor: null,
                        scale: 2
                    });
                    
                    if (format === 'png') {
                        const link = document.createElement('a');
                        link.download = `mindmap_${this.currentMindMap.map_id}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    } else if (format === 'pdf') {
                        if (typeof jsPDF !== 'undefined') {
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('landscape');
                            const imgData = canvas.toDataURL('image/png');
                            
                            const imgWidth = 297;
                            const pageHeight = 210;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, Math.min(imgHeight, pageHeight));
                            pdf.save(`mindmap_${this.currentMindMap.map_id}.pdf`);
                        }
                    }
                } catch (error) {
                    console.error('Image export error:', error);
                    this.showToast('Failed to export as image', 'error');
                }
            }
            
            downloadFile(data, filename) {
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            // AI Suggestions
            // This is the NEW function that calls the API
async getAISuggestions() {
    if (!this.currentMindMap) {
        this.showToast('Please select a mindmap first', 'warning');
        return;
    }

    if (!this.selectedNode) {
        this.showToast('Please select a node to get suggestions for', 'warning');
        return;
    }

    this.showToast('Getting AI suggestions...', 'info');

    try {
        // API call to the backend
        const response = await this.apiCall(`mindmap_api.php?action=ai-suggestions&node_id=${this.selectedNode.data.key}`, 'GET');
        
        if (response.success && response.data.length > 0) {
            const parentNode = this.selectedNode;

            response.data.forEach((suggestionText, index) => {
                // This adds the suggested nodes around the selected node
                this.addChildNode(parentNode, suggestionText);
            });
            this.showToast('AI suggestions added!', 'success');
            
        } else {
            this.showToast(response.message || 'No new suggestions found.', 'info');
        }
    } catch (error) {
        console.error('Failed to get AI suggestions:', error);
        this.showToast('Failed to get AI suggestions', 'error');
    }
}
            addSuggestionNode(text, index) {
                if (!this.diagram) return;
                
                const centerPoint = this.diagram.viewportBounds.center;
                const angle = (index * 72) * (Math.PI / 180); // 72 degrees apart
                const radius = 150;
                
                const newNodeData = {
                    key: 'ai_' + Date.now() + '_' + index,
                    text: text,
                    color: '#4facfe',
                    backgroundColor: '#ffffff',
                    textColor: '#000000',
                    fontSize: 12,
                    nodeType: 'sub',
                    priority: 'medium',
                    status: 'pending',
                    loc: `${centerPoint.x + radius * Math.cos(angle)} ${centerPoint.y + radius * Math.sin(angle)}`,
                    isNew: true
                };
                
                this.diagram.model.addNodeData(newNodeData);
            }
            
            // Utility Methods
            // This is the NEW function that calls the API
async loadCategories() {
    if (!this.authToken) return; // Categories are loaded for authenticated users
    try {
        const response = await this.apiCall('mindmap_api.php?action=categories', 'GET');
        if (response.success) {
            this.categories = response.data;
            this.populateCategorySelects();
        }
    } catch (error) {
        console.error('Failed to load categories:', error);
    }
}
            
            populateCategorySelects() {
                const selects = ['categoryFilter', 'mindmapCategory'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    // Clear existing options
                    if (selectId === 'categoryFilter') {
                        select.innerHTML = '<option value="">All Categories</option>';
                    } else {
                        select.innerHTML = '<option value="">Select Category</option>';
                    }
                    
                    // Add category options
                    this.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.category_id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                });
            }
            
            displayMindMapList(mindmaps) {
                const listContainer = document.getElementById('mindmapList');
                listContainer.innerHTML = '';
                
                if (mindmaps.length === 0) {
                    listContainer.innerHTML = '<li style="text-align: center; color: #666; padding: 1rem; opacity: 0.7;">No mindmaps found</li>';
                    return;
                }
                
                mindmaps.forEach(mindmap => {
                    const listItem = document.createElement('li');
                    listItem.className = 'mindmap-item';
                    listItem.onclick = () => this.loadMindMap(mindmap.map_id);
                    
                    listItem.innerHTML = `
                        <div class="mindmap-title">${mindmap.title}</div>
                        <div class="mindmap-meta">
                            <span><i class="fas fa-calendar"></i> ${new Date(mindmap.updated_at).toLocaleDateString()}</span>
                            <span><i class="fas fa-project-diagram"></i> ${mindmap.node_count || 0} nodes</span>
                            ${mindmap.category_name ? `<span><i class="fas fa-tag"></i> ${mindmap.category_name}</span>` : ''}
                        </div>
                    `;
                    
                    listContainer.appendChild(listItem);
                });
            }
            
            filterMindMaps(searchTerm) {
                const filtered = this.mindmaps.filter(mindmap => 
                    mindmap.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (mindmap.description && mindmap.description.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                this.displayMindMapList(filtered);
            }
            
            filterByCategory(categoryId) {
                let filtered = this.mindmaps;
                
                if (categoryId) {
                    filtered = this.mindmaps.filter(mindmap => 
                        mindmap.category_id == categoryId
                    );
                }
                
                this.displayMindMapList(filtered);
            }
            
            // Event Handlers
            onNodeSelectionChanged(node) {
                if (node.isSelected) {
                    this.selectedNode = node;
                }
            }
            
            onSelectionChanged() {
                if (!this.diagram) return;
                
                const selection = this.diagram.selection;
                if (selection.count === 1 && selection.first() instanceof go.Node) {
                    this.selectedNode = selection.first();
                } else {
                    this.selectedNode = null;
                    this.hidePropertiesPanel();
                }
            }
            
            onDiagramModified() {
                if (this.currentMindMap) {
                    this.currentMindMap.isModified = true;
                }
            }
            
            handleKeyboardShortcuts(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            this.saveMindMap();
                            break;
                        case 'n':
                            e.preventDefault();
                            this.addNode();
                            break;
                        case 'z':
                            e.preventDefault();
                            if (this.diagram) {
                                this.diagram.commandHandler.undo();
                            }
                            break;
                        case 'y':
                            e.preventDefault();
                            if (this.diagram) {
                                this.diagram.commandHandler.redo();
                            }
                            break;
                    }
                }
                
                if (e.key === 'Delete' && this.selectedNode) {
                    this.deleteNode(this.selectedNode);
                }
                
                if (e.key === 'Escape') {
                    this.hidePropertiesPanel();
                }
            }
            
            // UI State Management
            showAuthenticatedUI() {
                document.getElementById('userMenu').style.display = 'flex';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('signupBtn').style.display = 'none';
                document.getElementById('sidebar').classList.remove('hidden');
                
                if (this.currentUser) {
                    document.getElementById('userAvatar').textContent = this.currentUser.username.charAt(0).toUpperCase();
                }
            }
            
            showUnauthenticatedUI() {
                document.getElementById('userMenu').style.display = 'none';
                document.getElementById('loginBtn').style.display = 'inline-flex';
                document.getElementById('signupBtn').style.display = 'inline-flex';
                document.getElementById('welcomeScreen').style.display = 'flex';
            }
            
            hideWelcomeScreen() {
                document.getElementById('welcomeScreen').style.display = 'none';
            }
            
            showWelcomeScreen() {
                document.getElementById('welcomeScreen').style.display = 'flex';
                this.clearCanvas();
            }
            
            clearCanvas() {
                if (this.diagram) {
                    this.diagram.model = new go.GraphLinksModel();
                }
                this.updateCanvasTitle('Welcome to MindMap Platform');
            }
            
            updateCanvasTitle(title) {
                document.getElementById('canvasTitle').textContent = title;
            }
            
            // Modal Management
            showModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }
            
            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
            
            // Toast Notifications
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${this.getToastIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                document.getElementById('toastContainer').appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }
            
            getToastIcon(type) {
                switch (type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'warning': return 'exclamation-triangle';
                    case 'info': return 'info-circle';
                    default: return 'info-circle';
                }
            }
            
            async loadUserProfile() {
                try {
                    const response = await this.apiCall('auth.php?action=profile', 'GET');
                    if (response.success) {
                        this.currentUser = response.data;
                    }
                } catch (error) {
                    console.error('Failed to load user profile:', error);
                }
            }
            
            async shareMindMap() {
                if (!this.currentMindMap) {
                    this.showToast('No mindmap to share', 'warning');
                    return;
                }
                
                const shareUrl = `${window.location.origin}/share/${this.currentMindMap.map_id}`;
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: this.currentMindMap.title,
                            text: 'Check out this mind map!',
                            url: shareUrl
                        });
                    } catch (error) {
                        this.copyToClipboard(shareUrl);
                    }
                } else {
                    this.copyToClipboard(shareUrl);
                }
            }
            
            copyToClipboard(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showToast('Link copied to clipboard!', 'success');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showToast('Link copied to clipboard!', 'success');
                }
            }
        }

        // Global functions for modal management
        function showModal(modalId) {
            if (window.mindmapPlatform) {
                window.mindmapPlatform.showModal(modalId);
            }
        }

        function closeModal(modalId) {
            if (window.mindmapPlatform) {
                window.mindmapPlatform.closeModal(modalId);
            }
        }
        window.addEventListener('DOMContentLoaded', () => {
    new MindMapPlatform();
        });

        </script>
    </body>
</html>
